# Ralph Progress Log
Started: Wed Jan 28 23:18:45 CET 2026

## Codebase Patterns
- Xcode project structure: Browseroo.xcodeproj/project.pbxproj contains build configuration, Browseroo/ contains source files
- SwiftUI app uses @main attribute on App struct with Scene body
- Info.plist with LSUIElement=true makes app a menu bar agent (no Dock icon)
- Deployment target set in project.pbxproj under MACOSX_DEPLOYMENT_TARGET
- xcodebuild requires Xcode.app to be installed (Command Line Tools not sufficient)
- MenuBarExtra(title, systemImage:) is used for the menu bar dropdown (macOS 13.0+)
- Adding new .swift files requires 4 edits to project.pbxproj: PBXBuildFile, PBXFileReference, PBXGroup children, and PBXSourcesBuildPhase files
- Use LSCopyAllHandlersForURLScheme/LSCopyDefaultHandlerForURLScheme for browser detection (CoreServices)
- Use LSSetDefaultHandlerForURLScheme for both 'http' and 'https' to set default browser (CoreServices)
- Import AppKit when using NSApplication (e.g., for NSApplication.shared.terminate(nil) to quit app)
- Use NSApplication.shared.orderFrontStandardAboutPanel(options:) for native About dialogs; call activate(ignoringOtherApps:) first for menu bar apps
- Use SMAppService.mainApp from ServiceManagement framework for login items (macOS 13.0+); .register()/.unregister() to toggle, .status == .enabled to check state
- For VoiceOver accessibility: use .accessibilityLabel() on buttons (include state for toggles), .accessibilityHint() for action description, .accessibilityHidden(true) on decorative images
- SwiftUI MenuBarExtra provides standard macOS menu keyboard navigation automatically (arrow keys, Enter, Escape)
- Use AXIsProcessTrusted() from ApplicationServices to check Accessibility permission
- Open System Settings Accessibility: NSWorkspace.shared.open(URL(string: "x-apple.systempreferences:com.apple.preference.security?Privacy_Accessibility")!)
- Use NSAppleScript(source:) to run AppleScript from Swift; executeAndReturnError(&errorDict) runs it and returns result or nil
---

## 2026-01-28 - US-001
- What was implemented:
  - Created Xcode project named Browseroo with SwiftUI lifecycle
  - Set LSUIElement to true in Info.plist (no Dock icon)
  - Set minimum deployment target to macOS 13.0
  - Created app entitlements, asset catalogs, and basic SwiftUI app structure
- Files changed:
  - Browseroo.xcodeproj/project.pbxproj (new)
  - Browseroo/BrowserooApp.swift (new)
  - Browseroo/ContentView.swift (new)
  - Browseroo/Info.plist (new)
  - Browseroo/Browseroo.entitlements (new)
  - Browseroo/Assets.xcassets/* (new)
- **Learnings for future iterations:**
  - xcodebuild requires full Xcode.app installation, not just Command Line Tools
  - Use `swiftc -parse` to verify Swift syntax when xcodebuild unavailable
  - LSUIElement in Info.plist controls whether app appears in Dock
  - Deployment target is set in both Debug and Release configurations in project.pbxproj
---

## 2026-01-28 - US-002
- What was implemented:
  - Replaced WindowGroup with MenuBarExtra in BrowserooApp
  - App now displays a globe icon in the macOS menu bar
  - Clicking the icon opens a dropdown menu with placeholder text "Browseroo"
  - Combined with LSUIElement=true, app does not appear in Dock
- Files changed:
  - Browseroo/BrowserooApp.swift (modified)
- **Learnings for future iterations:**
  - MenuBarExtra is the SwiftUI way to create menu bar apps (available macOS 13.0+)
  - MenuBarExtra takes a title (for accessibility), systemImage (SF Symbol name), and content closure
  - ContentView.swift is no longer used for menu bar apps but can be kept for potential window scenes
---

## 2026-01-28 - US-003
- What was implemented:
  - Created Browser struct with bundleIdentifier, name, and icon properties
  - Created BrowserManager class with getInstalledBrowsers() method
  - Uses LSCopyAllHandlersForURLScheme to query HTTPS URL handlers
  - Filters using a whitelist of known browser bundle identifiers
  - Gets app name from CFBundleName/CFBundleDisplayName and icon from NSWorkspace
  - Returns sorted array of Browser objects
- Files changed:
  - Browseroo/Browser.swift (new)
  - Browseroo/BrowserManager.swift (new)
  - Browseroo.xcodeproj/project.pbxproj (modified - added new files)
- **Learnings for future iterations:**
  - LSCopyAllHandlersForURLScheme returns CFArray of bundle identifiers, needs cast to [String]
  - takeRetainedValue() transfers ownership from CF to Swift (avoids memory leaks)
  - NSWorkspace.shared.urlForApplication(withBundleIdentifier:) finds app location
  - NSWorkspace.shared.icon(forFile:) gets app icon as NSImage
  - Whitelist approach for browser filtering is more reliable than heuristics
  - New Swift files must be added to PBXBuildFile, PBXFileReference, PBXGroup, and PBXSourcesBuildPhase in project.pbxproj
---

## 2026-01-28 - US-004
- What was implemented:
  - Added getDefaultBrowser() method to BrowserManager class
  - Uses LSCopyDefaultHandlerForURLScheme with 'https' scheme to get default browser bundle ID
  - Returns a Browser object matching the default, or nil if it cannot be determined
  - Follows same pattern as getInstalledBrowsers() for fetching app name and icon
- Files changed:
  - Browseroo/BrowserManager.swift (modified)
- **Learnings for future iterations:**
  - LSCopyDefaultHandlerForURLScheme returns a single CFString (vs CFArray for LSCopyAllHandlersForURLScheme)
  - Cast pattern for default handler: LSCopyDefaultHandlerForURLScheme(...)?.takeRetainedValue() as String?
  - Default browser detection doesn't require whitelist filtering - it returns whatever the user has set
---

## 2026-01-28 - US-005
- What was implemented:
  - Created BrowserMenuView struct with @State properties for browsers list and default browser ID
  - Menu displays all installed browsers using ForEach over Browser array
  - Each browser shows icon (Image(nsImage:)) and name (Text)
  - Current default browser has a checkmark (Image(systemName: "checkmark"))
  - List refreshes when menu opens using .onAppear modifier
  - Button placeholder added for browser switching (to be implemented in US-006)
- Files changed:
  - Browseroo/BrowserooApp.swift (modified)
- **Learnings for future iterations:**
  - SwiftUI MenuBarExtra content uses standard SwiftUI views (Button, HStack, ForEach, etc.)
  - Image(nsImage:) is used to display NSImage in SwiftUI
  - Group wrapper needed around ForEach to attach .onAppear modifier
  - .onAppear is called each time the menu opens, ensuring fresh browser list
---

## 2026-01-28 - US-006
- What was implemented:
  - Added setDefaultBrowser(bundleIdentifier:) method to BrowserManager class
  - Uses LSSetDefaultHandlerForURLScheme for both 'http' and 'https' schemes
  - Returns Bool indicating success (both schemes must succeed)
  - Added switchToBrowser(_:) method in BrowserMenuView to handle button action
  - UI immediately updates defaultBrowserID state after switching (checkmark moves instantly)
- Files changed:
  - Browseroo/BrowserManager.swift (modified)
  - Browseroo/BrowserooApp.swift (modified)
- **Learnings for future iterations:**
  - LSSetDefaultHandlerForURLScheme returns OSStatus, compare with noErr for success
  - @discardableResult allows ignoring the return value when not needed
  - Must set both 'http' and 'https' schemes for complete browser switching
  - Updating @State property immediately makes UI responsive without waiting for refresh
---

## 2026-01-28 - US-007
- What was implemented:
  - Added Divider() between browser list and Quit option
  - Added "Quit Browseroo" Button with action to terminate application
  - Uses NSApplication.shared.terminate(nil) to quit the app
  - Added .keyboardShortcut("q") modifier for ⌘Q support
  - Added AppKit import for NSApplication access
- Files changed:
  - Browseroo/BrowserooApp.swift (modified)
- **Learnings for future iterations:**
  - NSApplication.shared.terminate(nil) is the standard way to quit a macOS app
  - .keyboardShortcut("q") automatically creates ⌘Q (Command modifier is default)
  - Divider() in SwiftUI creates a visual separator between menu items
  - Import AppKit is required to use NSApplication (not included in SwiftUI by default)
---

## 2026-01-28 - US-008
- What was implemented:
  - Added "About Browseroo" Button in menu (below divider, above Quit)
  - Uses NSApplication.shared.orderFrontStandardAboutPanel(options:) to show native macOS about panel
  - NSApplication.shared.activate(ignoringOtherApps: true) ensures the panel comes to front
  - Added version info to Info.plist: CFBundleShortVersionString (1.0), CFBundleVersion (1), NSHumanReadableCopyright
  - About panel displays app name, version number, and copyright
- Files changed:
  - Browseroo/BrowserooApp.swift (modified)
  - Browseroo/Info.plist (modified)
- **Learnings for future iterations:**
  - NSApplication.shared.orderFrontStandardAboutPanel(options:) shows the standard macOS About dialog
  - Options dict accepts keys: .applicationName, .applicationVersion, .version, .copyright
  - Bundle.main.object(forInfoDictionaryKey:) retrieves values from Info.plist at runtime
  - NSApplication.shared.activate(ignoringOtherApps: true) is needed to bring the panel to front for menu bar apps
  - CFBundleShortVersionString is the "marketing version" (e.g., 1.0), CFBundleVersion is the build number
---

## 2026-01-28 - US-009
- What was implemented:
  - Added "Launch at Login" toggle button in menu (between browser list and About)
  - Uses SMAppService.mainApp from ServiceManagement framework for login item management
  - Toggle shows checkmark when enabled, no checkmark when disabled
  - toggleLaunchAtLogin() method calls register() or unregister() based on current state
  - State refreshes on menu open (in refreshBrowserList()) to reflect external changes
  - State persists automatically via SMAppService (macOS manages the login items)
- Files changed:
  - Browseroo/BrowserooApp.swift (modified)
- **Learnings for future iterations:**
  - SMAppService.mainApp (ServiceManagement framework) is the modern API for login items (macOS 13.0+)
  - SMAppService.mainApp.status == .enabled checks if login item is currently enabled
  - SMAppService.mainApp.register() / .unregister() enable/disable login item (throws errors)
  - State is managed by macOS - no need to persist in UserDefaults
  - Import ServiceManagement to use SMAppService
---

## 2026-01-28 - US-010
- What was implemented:
  - Added comprehensive accessibility support for VoiceOver
  - Browser buttons have accessibility labels indicating browser name and current default status
  - Launch at Login toggle has accessibility label showing enabled/disabled state
  - About and Quit buttons have accessibility labels and hints
  - Decorative images (icons, checkmarks) hidden from accessibility tree with .accessibilityHidden(true)
  - Keyboard navigation (arrow keys, Enter/Return, Escape) works via built-in macOS menu behavior
- Files changed:
  - Browseroo/BrowserooApp.swift (modified)
- **Learnings for future iterations:**
  - SwiftUI MenuBarExtra inherits standard macOS NSMenu keyboard navigation automatically
  - Arrow keys, Enter/Return, and Escape all work without additional code
  - Use .accessibilityLabel() on interactive elements to describe their state
  - Use .accessibilityHint() to describe what happens when activated
  - Use .accessibilityHidden(true) on decorative images to prevent VoiceOver from reading them
  - For toggles/checkmarks, include the current state in the accessibility label
---

## 2026-01-29 - US-011
- What was implemented:
  - Created AccessibilityManager class with static methods for accessibility permission handling
  - isAccessibilityGranted() uses AXIsProcessTrusted() from ApplicationServices framework
  - showAccessibilityAlert() displays NSAlert explaining why permission is needed with two buttons
  - openAccessibilitySettings() opens System Settings to Privacy & Security > Accessibility using x-apple.systempreferences URL scheme
  - Added accessibilityGranted @State property to BrowserMenuView
  - Added requestAccessibilityPermission() method to trigger permission request flow
  - Integrated accessibility check in refreshBrowserList() to update state when menu opens
- Files changed:
  - Browseroo/AccessibilityManager.swift (new)
  - Browseroo/BrowserooApp.swift (modified)
  - Browseroo.xcodeproj/project.pbxproj (modified - added new file)
- **Learnings for future iterations:**
  - AXIsProcessTrusted() from ApplicationServices returns Bool for accessibility permission check
  - x-apple.systempreferences:com.apple.preference.security?Privacy_Accessibility opens Accessibility settings on macOS 13+
  - NSAlert.runModal() returns .alertFirstButtonReturn for the first button added with addButton(withTitle:)
  - NSApplication.shared.activate(ignoringOtherApps: true) needed before showing alerts from menu bar apps
---

## 2026-01-29 - US-012
- What was implemented:
  - Created ConfirmationDialogHandler class with static AppleScript and execution method
  - AppleScript targets CoreServicesUIAgent process which displays the default browser confirmation dialog
  - Script finds button whose name starts with "Use " and clicks it to confirm browser change
  - Handles case where no dialog is present (returns .noDialog instead of error)
  - ConfirmResult enum provides typed results: .clicked, .noDialog, .error(String)
  - clickConfirmButton() method executes script via NSAppleScript and returns typed result
- Files changed:
  - Browseroo/ConfirmationDialogHandler.swift (new)
  - Browseroo.xcodeproj/project.pbxproj (modified - added new file)
- **Learnings for future iterations:**
  - NSAppleScript(source:) creates an AppleScript from a string
  - executeAndReturnError(&errorDict) runs the script; returns NSAppleEventDescriptor or nil on error
  - errorDict[NSAppleScript.errorMessage] contains error message if execution fails
  - AppleScript uses "tell application System Events" to interact with UI elements
  - CoreServicesUIAgent is the process that shows the default browser confirmation dialog
  - AppleScript "name of btn starts with 'Use '" matches buttons like "Use Chrome", "Use Safari"
---

## 2026-01-29 - US-013
- What was implemented:
  - Modified BrowserManager.setDefaultBrowser() to execute AppleScript after setting default browser
  - Added autoConfirm parameter (default true) to control whether to auto-click confirmation dialog
  - Created autoConfirmBrowserChange() private method that runs asynchronously on background queue
  - Implemented 150ms delay using Thread.sleep(forTimeInterval:) to allow dialog to appear
  - Calls ConfirmationDialogHandler.clickConfirmButton() after delay
  - Errors handled gracefully - result is discarded with _ = assignment
- Files changed:
  - Browseroo/BrowserManager.swift (modified)
- **Learnings for future iterations:**
  - Use DispatchQueue.global(qos: .userInitiated).async {} to run code asynchronously without blocking UI
  - Thread.sleep(forTimeInterval:) takes seconds (0.15 = 150ms)
  - Use _ = assignment to explicitly discard return values when error handling not needed
  - Default parameter values allow backward compatibility (autoConfirm: Bool = true)
---

## 2026-01-29 - US-014
- What was implemented:
  - Added "Auto-Confirm" section in menu between "Launch at Login" toggle and the About/Quit divider
  - When Accessibility permission is granted: shows "Auto-Confirm" label with checkmark, button disabled
  - When permission not granted: shows "Auto-Confirm: Grant Permission..." button
  - Clicking "Grant Permission..." calls requestAccessibilityPermission() which triggers the alert from US-011
  - Accessibility labels and hints added for VoiceOver support
  - Uses existing accessibilityGranted @State property which refreshes on menu open
- Files changed:
  - Browseroo/BrowserooApp.swift (modified)
- **Learnings for future iterations:**
  - SwiftUI if/else inside Group can conditionally show different views based on state
  - Use .disabled(true) on Button to make it non-interactive while still visible (for status display)
  - Empty action closure `action: {}` needed for disabled buttons that just show status
---

## 2026-01-29 - US-015
- What was implemented:
  - Fixed AppleScript in ConfirmationDialogHandler to use direct button targeting instead of repeat loop
  - Replaced `repeat with btn in buttons` loop with `click (first button whose name starts with "Use ")`
  - Added `exists` check before clicking to gracefully handle no-dialog case
  - The original repeat loop failed silently when iterating over buttons
- Files changed:
  - Browseroo/ConfirmationDialogHandler.swift (modified)
- **Learnings for future iterations:**
  - AppleScript repeat loops over UI elements can fail silently in some contexts
  - Direct button targeting with `click (first button whose name starts with "X")` is more reliable
  - Always use `if exists` check before attempting to click dynamic UI elements
  - Use `first button whose name starts with` for partial name matching in AppleScript
---

## 2026-01-29 - US-016
- What was implemented:
  - Added comprehensive error logging to ConfirmationDialogHandler.clickConfirmButton()
  - When AppleScript execution fails, logs errorNumber, errorMessage, errorBriefMessage from error dictionary
  - Logs full error dictionary for complete diagnostic information
  - All logs use [Browseroo] prefix for easy filtering with: log stream --predicate 'process == "Browseroo"' --level debug
  - Only logs on errors, not on successful execution (per requirements)
- Files changed:
  - Browseroo/ConfirmationDialogHandler.swift (modified)
- **Learnings for future iterations:**
  - NSAppleScript.errorNumber, NSAppleScript.errorMessage, NSAppleScript.errorBriefMessage are the keys for error info
  - Print statements in macOS apps appear in Console.app or via `log stream` command
  - Using a consistent prefix like [Browseroo] makes filtering logs easy
---

## 2026-01-29 - US-017
- What was implemented:
  - Created scripts/test-auto-confirm.sh for automated testing of auto-confirm feature
  - Script builds Browseroo with xcodebuild, launches the app
  - Uses osascript to detect current default browser and select an alternative
  - Uses AppleScript via System Events to click menu bar icon and select browser from menu
  - Waits 3 seconds for auto-confirm to process any dialog
  - Checks CoreServicesUIAgent window count to determine if confirmation dialog is present
  - Reports PASS (exit 0) if no dialog, FAIL (exit 1) if dialog present
  - Quits Browseroo cleanly and includes cleanup for any remaining dialogs
- Files changed:
  - scripts/test-auto-confirm.sh (new)
- **Learnings for future iterations:**
  - MenuBarExtra items are accessed via `menu bar item 1 of menu bar 2` in AppleScript (menu bar 1 is the Apple menu bar, menu bar 2 is extras)
  - Use `process "AppName"` to target a menu bar app's System Events process
  - CoreServicesUIAgent is the process that shows the default browser confirmation dialog
  - osascript can get app path via `tell application "System Events" to get path of application id "bundleID"`
  - Shell scripts can use `$(cat <<'EOF' ... EOF)` for multi-line strings with special characters
---
